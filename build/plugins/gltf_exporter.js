!function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){"use strict";r.r(t);r(2);!function(){const e=new Codec("gltf",{name:"GL Transmission Format",extension:"gltf",compile:e=>new Promise(t=>{new Promise(t=>{const r=new THREE.GLTFExporter,n=["vertex_handles","outline_group","grid_group","side_grid_x","side_grid_y","sun","lights"];let a=new THREE.Group;a.name=e.geometry_name,a.rotation.y=THREE.Math.degToRad(180),scene.children.forEach(e=>{n.includes(e.name)||e instanceof THREE.TransformControls||a.add(e.clone(!0))});new THREE.Vector3(1,1,1);const i=e.animations?function(){const e=[];return Animator.animations.forEach(t=>{const r=[];for(const e in t.animators){const n=t.animators[e];if(!(n instanceof EffectAnimator)&&n.keyframes.length&&n.group){const e=n.group,t=e.mesh,a={rotation:{},position:{},scale:{}};if(n.keyframes.forEach(e=>{let t=Math.clamp(trimFloatNumber(Math.round(60*e.time)/60),0);a[e.channel][t]=e.getArray()}),Object.keys(a.position).length>0){const n=[],i=[];Object.keys(a.position).sort().forEach(e=>{const r=new THREE.Vector3;r.copy(t.fix_position);const o=(new THREE.Vector3).fromArray(a.position[e]);o.x*=-1,r.add(o),n.push(e),i.push(r.x,r.y,r.z)}),i.length>0&&r.push(new THREE.VectorKeyframeTrack(e.name+".position",n,i))}if(Object.keys(a.rotation).length>0){const n=[],i=[];Object.keys(a.rotation).sort().forEach(e=>{const r=new THREE.Vector3;r.copy(t.fix_rotation);const o=a.rotation[e],s=new THREE.Quaternion;if(4===o.length){const e=(new THREE.Euler).setFromQuaternion((new THREE.Quaternion).fromArray(o),"ZYX");r.x-=e.x,r.y-=e.y,r.z+=e.z,s.setFromEuler(new THREE.Euler(r.x,r.y,r.z,"ZYX"))}else s.setFromEuler(new THREE.Euler(THREE.Math.degToRad(-o[0]),THREE.Math.degToRad(-o[1]),THREE.Math.degToRad(o[2])));i.push(s.x,s.y,s.z,s.w),n.push(e)}),i.length>0&&r.push(new THREE.QuaternionKeyframeTrack(e.name+".quaternion",n,i))}if(Object.keys(a.scale).length>0){const e=[],r=[];Object.keys(a.scale).sort().forEach(n=>{const i=new THREE.Vector3;i.copy(t.scale);const o=a.scale[n];i.x*=o[0]||1e-5,i.y*=o[1]||1e-5,i.z*=o[2]||1e-5,r.push(i.x,i.y,i.z),e.push(n)})}}}r.length>0&&e.push(new THREE.AnimationClip(t.name,t.length,r))}),e}():[];r.parse(elements,a,e=>t(e),{binary:!1,embedImages:!0,animations:i})}).then(e=>{t(JSON.stringify(e))})}),export(e){const t=this;isApp?Blockbench.export({type:this.name,extensions:[this.extension],name:this.fileName(),startpath:this.startPath(),custom_writer:(r,n)=>{t.compile(e).then(e=>{r=e,Blockbench.writeFile(n,{content:r},e=>t.afterSave(e))})}}):this.compile(e).then(e=>{Blockbench.export({type:this.name,extensions:[this.extension],name:this.fileName(),content:e},e=>t.afterDownload(e))})}});e.export_action=new Action({id:"export_gltf",name:"Export GLTF",icon:"icon-objects",description:"Export Model to GLTF",category:"file",click:()=>{const t=Project.geometry_name||"object";new Dialog({id:"gltf_export_options",title:"Export glTF",lines:["<style>\n                        .dialog_bar {\n                            display: grid;\n                            grid-template-columns: 2fr 1fr;\n                        }\n                        .dialog_bar > :first-child:not(button) {\n                            width: min-content !important;\n                        }\n                        .dialog_bar > :last-child:not(button) {\n                            width: 100% !important;\n                            display: block !important;\n                        }\n                        #gltf_export_options > div:nth-child(10) {\n                            display: block;\n                            margin-top: 1rem;\n                        }\n                        input:read-only {\n                            cursor: not-allowed;\n                        }\n                    </style>","<h1>Export Settings</h1>"],form:{geoName:{label:"Geometry Name",type:"input",value:t},animations:{label:"Animations",type:"checkbox",value:!0}},onConfirm:function(t){e.export({scale:new THREE.Vector3(t.scaleX,t.scaleY,t.scaleZ),binary:"binary"===t.binary,embedImages:t.embedImages,animations:t.animations,geometry_name:t.geoName}),this.hide()}}).show()}}),Plugin.register("gltf_exporter",{title:"glTF Exporter",author:"Elenterius",icon:"icon-objects",description:"Export Model to glTF Fileformat",version:"1.0.0-alpha.4",variant:"both",onload(){MenuBar.addAction(e.export_action,"file.export"),console.log("glTF Exporter [1.0.0-alpha.4] loaded!")},onunload(){e.export_action.delete(),delete THREE.GLTFExporter}})}()},function(e,t){var r=0,n=1,a=2,i=3,o=4,s=5,l=6,u=5121,c=5123,f=5126,p=5125,m=34962,h=34963,g=9728,d=9729,E=9984,y=9985,T=9986,v=9987,b=33071,x=33648,w=10497,R={};R[THREE.NearestFilter]=g,R[THREE.NearestMipMapNearestFilter]=E,R[THREE.NearestMipMapLinearFilter]=T,R[THREE.LinearFilter]=d,R[THREE.LinearMipMapNearestFilter]=y,R[THREE.LinearMipMapLinearFilter]=v,R[THREE.ClampToEdgeWrapping]=b,R[THREE.RepeatWrapping]=w,R[THREE.MirroredRepeatWrapping]=x;var M={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};THREE.GLTFExporter=function(){},THREE.GLTFExporter.prototype={constructor:THREE.GLTFExporter,parse:function(e,t,g,d){(d=Object.assign({},{binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,animations:[],forceIndices:!1,forcePowerOfTwoTextures:!1,includeCustomExtensions:!1},d)).animations.length>0&&(d.trs=!0);var E,y={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},T=0,v=[],b=[],x=new Map,w=[],H={},L={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},A=new Map,F=0;function I(e){return A.has(e)||A.set(e,F++),A.get(e)}function S(e,t){return e.length===t.length&&e.every((function(e,r){return e===t[r]}))}function _(e){return 4*Math.ceil(e/4)}function O(e,t){t=t||0;var r=_(e.byteLength);if(r!==e.byteLength){var n=new Uint8Array(r);if(n.set(new Uint8Array(e)),0!==t)for(var a=e.byteLength;a<r;a++)n[a]=t;return n.buffer}return e}function N(e,t){if(0!==Object.keys(e.userData).length)try{var r=JSON.parse(JSON.stringify(e.userData));if(d.includeCustomExtensions&&r.gltfExtensions){for(var n in void 0===t.extensions&&(t.extensions={}),r.gltfExtensions)t.extensions[n]=r.gltfExtensions[n],H[n]=!0;delete r.gltfExtensions}Object.keys(r).length>0&&(t.extras=r)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}function k(e,t){var r=!1,n={};0===t.offset.x&&0===t.offset.y||(n.offset=t.offset.toArray(),r=!0),0!==t.rotation&&(n.rotation=t.rotation,r=!0),1===t.repeat.x&&1===t.repeat.y||(n.scale=t.repeat.toArray(),r=!0),r&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=n,H.KHR_texture_transform=!0)}function G(e){return y.buffers||(y.buffers=[{byteLength:0}]),v.push(e),0}function B(e,t,r,n){var a;if(e.array.constructor===Float32Array)a=f;else if(e.array.constructor===Uint32Array)a=p;else if(e.array.constructor===Uint16Array)a=c;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");a=u}if(void 0===r&&(r=0),void 0===n&&(n=e.count),d.truncateDrawRange&&void 0!==t&&null===t.index){var i=r+n,o=t.drawRange.count===1/0?e.count:t.drawRange.start+t.drawRange.count;r=Math.max(r,t.drawRange.start),(n=Math.min(i,o)-r)<0&&(n=0)}if(0===n)return null;var s,l=function(e,t,r){for(var n={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)},a=t;a<t+r;a++)for(var i=0;i<e.itemSize;i++){var o=e.array[a*e.itemSize+i];n.min[i]=Math.min(n.min[i],o),n.max[i]=Math.max(n.max[i],o)}return n}(e,r,n);void 0!==t&&(s=e===t.index?h:m);var g=function(e,t,r,n,a){var i;y.bufferViews||(y.bufferViews=[]),i=t===u?1:t===c?2:4;for(var o=_(n*e.itemSize*i),s=new DataView(new ArrayBuffer(o)),l=0,h=r;h<r+n;h++)for(var g=0;g<e.itemSize;g++){var d=e.array[h*e.itemSize+g];t===f?s.setFloat32(l,d,!0):t===p?s.setUint32(l,d,!0):t===c?s.setUint16(l,d,!0):t===u&&s.setUint8(l,d),l+=i}var E={buffer:G(s.buffer),byteOffset:T,byteLength:o};return void 0!==a&&(E.target=a),a===m&&(E.byteStride=e.itemSize*i),T+=o,y.bufferViews.push(E),{id:y.bufferViews.length-1,byteLength:0}}(e,a,r,n,s),E={bufferView:g.id,byteOffset:g.byteOffset,componentType:a,count:n,max:l.max,min:l.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return y.accessors||(y.accessors=[]),y.accessors.push(E),y.accessors.length-1}function C(e,t,r){L.images.has(e)||L.images.set(e,{});var n=L.images.get(e),a=t===THREE.RGBAFormat?"image/png":"image/jpeg",i=a+":flipY/"+r.toString();if(void 0!==n[i])return n[i];y.images||(y.images=[]);var o={mimeType:a};if(d.embedImages){var s=E=E||document.createElement("canvas");s.width=e.width,s.height=e.height,d.forcePowerOfTwoTextures&&!function(e){return THREE.Math.isPowerOfTwo(e.width)&&THREE.Math.isPowerOfTwo(e.height)}(e)&&(console.warn("GLTFExporter: Resized non-power-of-two image.",e),s.width=THREE.Math.floorPowerOfTwo(s.width),s.height=THREE.Math.floorPowerOfTwo(s.height));var l=s.getContext("2d");!0===r&&(l.translate(0,s.height),l.scale(1,-1)),l.drawImage(e,0,0,s.width,s.height),!0===d.binary?b.push(new Promise((function(e){s.toBlob((function(t){(function(e){return y.bufferViews||(y.bufferViews=[]),new Promise((function(t){var r=new window.FileReader;r.readAsArrayBuffer(e),r.onloadend=function(){var e=O(r.result),n={buffer:G(e),byteOffset:T,byteLength:e.byteLength};T+=e.byteLength,y.bufferViews.push(n),t(y.bufferViews.length-1)}}))})(t).then((function(t){o.bufferView=t,e()}))}),a)}))):o.uri=s.toDataURL(a)}else o.uri=e.src;y.images.push(o);var u=y.images.length-1;return n[i]=u,u}function z(e){y.samplers||(y.samplers=[]);var t={magFilter:R[e.magFilter],minFilter:R[e.minFilter],wrapS:R[e.wrapS],wrapT:R[e.wrapT]};return y.samplers.push(t),y.samplers.length-1}function V(e){if(L.textures.has(e))return L.textures.get(e);y.textures||(y.textures=[]);var t={sampler:z(e),source:C(e.image,e.format,e.flipY)};y.textures.push(t);var r=y.textures.length-1;return L.textures.set(e,r),r}function P(e){if(L.materials.has(e))return L.materials.get(e);if(y.materials||(y.materials=[]),e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;var t={pbrMetallicRoughness:{}};e.isMeshBasicMaterial?(t.extensions={KHR_materials_unlit:{}},H.KHR_materials_unlit=!0):e.isMeshStandardMaterial||console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");var r=e.color.toArray().concat([e.opacity]);if(S(r,[1,1,1,1])||(t.pbrMetallicRoughness.baseColorFactor=r),e.isMeshStandardMaterial?(t.pbrMetallicRoughness.metallicFactor=e.metalness,t.pbrMetallicRoughness.roughnessFactor=e.roughness):e.isMeshBasicMaterial?(t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9):(t.pbrMetallicRoughness.metallicFactor=.5,t.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap)if(e.metalnessMap===e.roughnessMap){var n={index:V(e.metalnessMap)};k(n,e.metalnessMap),t.pbrMetallicRoughness.metallicRoughnessTexture=n}else console.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.");if(e.map){var a={index:V(e.map)};k(a,e.map),t.pbrMetallicRoughness.baseColorTexture=a}if(e.isMeshBasicMaterial||e.isLineBasicMaterial||e.isPointsMaterial);else{var i=e.emissive.clone().multiplyScalar(e.emissiveIntensity).toArray();if(S(i,[0,0,0])||(t.emissiveFactor=i),e.emissiveMap){var o={index:V(e.emissiveMap)};k(o,e.emissiveMap),t.emissiveTexture=o}}if(e.normalMap){var s={index:V(e.normalMap)};-1!==e.normalScale.x&&(e.normalScale.x!==e.normalScale.y&&console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),s.scale=e.normalScale.x),k(s,e.normalMap),t.normalTexture=s}if(e.aoMap){var l={index:V(e.aoMap),texCoord:1};1!==e.aoMapIntensity&&(l.strength=e.aoMapIntensity),k(l,e.aoMap),t.occlusionTexture=l}(e.transparent||e.alphaTest>0)&&(t.alphaMode=e.opacity<1?"BLEND":"MASK",e.alphaTest>0&&.5!==e.alphaTest&&(t.alphaCutoff=e.alphaTest)),e.side===THREE.DoubleSide&&(t.doubleSided=!0),""!==e.name&&(t.name=e.name),N(e,t),y.materials.push(t);var u=y.materials.length-1;return L.materials.set(e,u),u}function D(e){var t=e.geometry.uuid+":"+e.material.uuid;if(L.meshes.has(t))return L.meshes.get(t);var u,c=e.geometry;e.isLineSegments?u=n:e.isLineLoop?u=a:e.isLine?u=i:e.isPoints?u=r:(c.isBufferGeometry||(c=(new THREE.BufferGeometry).fromGeometry(c)),e.drawMode===THREE.TriangleFanDrawMode?(console.warn("GLTFExporter: TriangleFanDrawMode and wireframe incompatible."),u=l):u=e.drawMode===THREE.TriangleStripDrawMode?e.material.wireframe?i:s:e.material.wireframe?n:o);var f={},p={},m=[],h=[],g={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},E=void 0;try{E=c.getAttribute("normal")}catch(e){if(!(e instanceof TypeError))throw e;console.warn(e)}void 0===E||function(e){if(L.attributesNormalized.has(e))return!1;for(var t=new THREE.Vector3,r=0,n=e.count;r<n;r++)if(Math.abs(t.fromArray(e.array,3*r).length()-1)>5e-4)return!1;return!0}(E)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),c.addAttribute("normal",function(e){if(L.attributesNormalized.has(e))return L.attributesNormalized.get(e);for(var t=e.clone(),r=new THREE.Vector3,n=0,a=t.count;n<a;n++)r.fromArray(t.array,3*n),0===r.x&&0===r.y&&0===r.z?r.setX(1):r.normalize(),r.toArray(t.array,3*n);return L.attributesNormalized.set(e,t),t}(E)));var T=null;for(var v in c.attributes)if("morph"!==v.substr(0,5)){var b=c.attributes[v];v=g[v]||v.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(v)||(v="_"+v),L.attributes.has(I(b)))p[v]=L.attributes.get(I(b));else{T=null;var x=b.array;"JOINTS_0"!==v||x instanceof Uint16Array||x instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),T=new THREE.BufferAttribute(new Uint16Array(x),b.itemSize,b.normalized));var w=B(T||b,c);null!==w&&(p[v]=w,L.attributes.set(I(b),w))}}if(void 0!==E&&c.addAttribute("normal",E),0===Object.keys(p).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){var R=[],M=[],H={};if(void 0!==e.morphTargetDictionary)for(var A in e.morphTargetDictionary)H[e.morphTargetDictionary[A]]=A;for(var F=0;F<e.morphTargetInfluences.length;++F){var S={},_=!1;for(var v in c.morphAttributes)if("position"===v||"normal"===v){b=c.morphAttributes[v][F];var O=v.toUpperCase(),k=c.attributes[v];if(L.attributes.has(I(b)))S[O]=L.attributes.get(I(b));else{for(var G=b.clone(),C=0,z=b.count;C<z;C++)G.setXYZ(C,b.getX(C)-k.getX(C),b.getY(C)-k.getY(C),b.getZ(C)-k.getZ(C));S[O]=B(G,c),L.attributes.set(I(k),S[O])}}else _||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),_=!0);h.push(S),R.push(e.morphTargetInfluences[F]),void 0!==e.morphTargetDictionary&&M.push(H[F])}f.weights=R,M.length>0&&(f.extras={},f.extras.targetNames=M)}var V=d.forceIndices,D=Array.isArray(e.material);if(D&&0===c.groups.length)return null;!V&&null===c.index&&D&&(console.warn("THREE.GLTFExporter: Creating index for non-indexed multi-material mesh."),V=!0);var U=!1;if(null===c.index&&V){for(var j=[],K=(F=0,c.attributes.position.count);F<K;F++)j[F]=F;c.setIndex(j),U=!0}var X=D?e.material:[e.material],Y=D?c.groups:[{materialIndex:0,start:void 0,count:void 0}];for(F=0,K=Y.length;F<K;F++){var J={mode:u,attributes:p};if(N(c,J),h.length>0&&(J.targets=h),null!==c.index){t=I(c.index);void 0===Y[F].start&&void 0===Y[F].count||(t+=":"+Y[F].start+":"+Y[F].count),L.attributes.has(t)?J.indices=L.attributes.get(t):(J.indices=B(c.index,c,Y[F].start,Y[F].count),L.attributes.set(t,J.indices)),null===J.indices&&delete J.indices}var W=P(X[Y[F].materialIndex]);null!==W&&(J.material=W),m.push(J)}U&&c.setIndex(null),f.primitives=m,y.meshes||(y.meshes=[]),y.meshes.push(f);var Z=y.meshes.length-1;return L.meshes.set(t,Z),Z}function U(e,t){y.animations||(y.animations=[]);for(var r=(e=THREE.GLTFExporter.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,n=[],a=[],i=0;i<r.length;++i){var o=r[i],s=THREE.PropertyBinding.parseTrackName(o.name),l=THREE.PropertyBinding.findNode(t,s.nodeName),u=M[s.propertyName];if("bones"===s.objectName&&(l=!0===l.isSkinnedMesh?l.skeleton.getBoneByName(s.objectIndex):void 0),!l||!u)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',o.name),null;var c,f=o.values.length/o.times.length;u===M.morphTargetInfluences&&(f/=l.morphTargetInfluences.length),!0===o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(c="CUBICSPLINE",f/=3):c=o.getInterpolation()===THREE.InterpolateDiscrete?"STEP":"LINEAR",a.push({input:B(new THREE.BufferAttribute(o.times,1)),output:B(new THREE.BufferAttribute(o.values,f)),interpolation:c}),n.push({sampler:a.length-1,target:{node:x.get(l),path:u}})}return y.animations.push({name:e.name||"clip_"+y.animations.length,samplers:a,channels:n}),y.animations.length-1}function j(e){var t=y.nodes[x.get(e)],r=e.skeleton,n=e.skeleton.bones[0];if(void 0===n)return null;for(var a=[],i=new Float32Array(16*r.bones.length),o=0;o<r.bones.length;++o)a.push(x.get(r.bones[o])),r.boneInverses[o].toArray(i,16*o);return void 0===y.skins&&(y.skins=[]),y.skins.push({inverseBindMatrices:B(new THREE.BufferAttribute(i,16)),joints:a,skeleton:x.get(n)}),t.skin=y.skins.length-1}function K(e){var t={};e.name&&(t.name=e.name),t.color=e.color.toArray(),t.intensity=e.intensity,e.isDirectionalLight?t.type="directional":e.isPointLight?(t.type="point",e.distance>0&&(t.range=e.distance)):e.isSpotLight&&(t.type="spot",e.distance>0&&(t.range=e.distance),t.spot={},t.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,t.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1.");var r=y.extensions.KHR_lights_punctual.lights;return r.push(t),r.length-1}function X(t){y.nodes||(y.nodes=[]);var r={};if(d.trs){var n=t.quaternion.toArray(),a=t.position.toArray(),i=t.scale.toArray();S(n,[0,0,0,1])||(r.rotation=n),S(a,[0,0,0])||(r.translation=a),S(i,[1,1,1])||(r.scale=i)}else t.matrixAutoUpdate&&t.updateMatrix(),S(t.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])||(r.matrix=t.matrix.elements);if(""!==t.name&&(r.name=String(t.name)),N(t,r),t.isMesh||t.isLine||t.isPoints){var o=D(t);null!==o&&(r.mesh=o)}else if(t.isCamera)r.camera=function(e){y.cameras||(y.cameras=[]);var t=e.isOrthographicCamera,r={type:t?"orthographic":"perspective"};return t?r.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:r.perspective={aspectRatio:e.aspect,yfov:THREE.Math.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(r.name=e.type),y.cameras.push(r),y.cameras.length-1}(t);else if(t.isDirectionalLight||t.isPointLight||t.isSpotLight)H.KHR_lights_punctual||(y.extensions=y.extensions||{},y.extensions.KHR_lights_punctual={lights:[]},H.KHR_lights_punctual=!0),r.extensions=r.extensions||{},r.extensions.KHR_lights_punctual={light:K(t)};else if(t.isLight)return console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",t),null;if(t.isSkinnedMesh&&w.push(t),t.children.length>0){for(var s=[],l=0,u=t.children.length;l<u;l++){var c=t.children[l];if(c instanceof THREE.Mesh){const t=e.findInArray("uuid",c.name);if(!t)continue;if(!1===t.export)continue}if(c.visible||!1===d.onlyVisible){var f=X(c);null!==f&&s.push(f)}}s.length>0&&(r.children=s)}y.nodes.push(r);var p=y.nodes.length-1;return x.set(t,p),p}function Y(t){y.scenes||(y.scenes=[],y.scene=0);var r={nodes:[]};""!==t.name&&(r.name=t.name),t.userData&&Object.keys(t.userData).length>0&&(r.extras=N(t)),y.scenes.push(r);for(var n=[],a=0,i=t.children.length;a<i;a++){var o=t.children[a];if(o instanceof THREE.Mesh){const t=e.findInArray("uuid",o.name);if(!t)continue;if(!1===t.export)continue}if(o.visible||!1===d.onlyVisible){var s=X(o);null!==s&&n.push(s)}}n.length>0&&(r.nodes=n),N(t,r)}!function(t){t=t instanceof Array?t:[t];for(var r=[],n=0;n<t.length;n++)t[n]instanceof THREE.Scene?Y(t[n]):r.push(t[n]);for(r.length>0&&function(t){var r=new THREE.Scene;r.name="AuxScene";for(var n=0;n<t.length;n++){if(t[n]instanceof THREE.Mesh){const r=e.findInArray("uuid",t[n].name);if(!r)continue;if(!1===r.export)continue}r.children.push(t[n])}Y(r)}(r),n=0;n<w.length;++n)j(w[n]);for(n=0;n<d.animations.length;++n)U(d.animations[n],t[0])}(t),Promise.all(b).then((function(){var e=new Blob(v,{type:"application/octet-stream"}),t=Object.keys(H);if(t.length>0&&(y.extensionsUsed=t),y.buffers&&y.buffers.length>0){y.buffers[0].byteLength=e.size;var r=new window.FileReader;if(!0===d.binary){r.readAsArrayBuffer(e),r.onloadend=function(){var e=O(r.result),t=new DataView(new ArrayBuffer(8));t.setUint32(0,e.byteLength,!0),t.setUint32(4,5130562,!0);var n=O(function(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;for(var t=new Uint8Array(new ArrayBuffer(e.length)),r=0,n=e.length;r<n;r++){var a=e.charCodeAt(r);t[r]=a>255?32:a}return t.buffer}(JSON.stringify(y)),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,n.byteLength,!0),a.setUint32(4,1313821514,!0);var i=new ArrayBuffer(12),o=new DataView(i);o.setUint32(0,1179937895,!0),o.setUint32(4,2,!0);var s=12+a.byteLength+n.byteLength+t.byteLength+e.byteLength;o.setUint32(8,s,!0);var l=new Blob([i,a,n,t,e],{type:"application/octet-stream"}),u=new window.FileReader;u.readAsArrayBuffer(l),u.onloadend=function(){g(u.result)}}}else r.readAsDataURL(e),r.onloadend=function(){var e=r.result;y.buffers[0].uri=e,g(y)}}else g(y)}))}},THREE.GLTFExporter.Utils={insertKeyframe:function(e,t){var r,n=e.getValueSize(),a=new e.TimeBufferType(e.times.length+1),i=new e.ValueBufferType(e.values.length+n),o=e.createInterpolant(new e.ValueBufferType(n));if(0===e.times.length){a[0]=t;for(var s=0;s<n;s++)i[s]=0;r=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<.001)return 0;a[0]=t,a.set(e.times,1),i.set(o.evaluate(t),0),i.set(e.values,n),r=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<.001)return e.times.length-1;a[a.length-1]=t,a.set(e.times,0),i.set(e.values,0),i.set(o.evaluate(t),e.values.length),r=a.length-1}else for(s=0;s<e.times.length;s++){if(Math.abs(e.times[s]-t)<.001)return s;if(e.times[s]<t&&e.times[s+1]>t){a.set(e.times.slice(0,s+1),0),a[s+1]=t,a.set(e.times.slice(s+1),s+2),i.set(e.values.slice(0,(s+1)*n),0),i.set(o.evaluate(t),(s+1)*n),i.set(e.values.slice((s+1)*n),(s+2)*n),r=s+1;break}}return e.times=a,e.values=i,r},mergeMorphTargetTracks:function(e,t){for(var r=[],n={},a=e.tracks,i=0;i<a.length;++i){var o=a[i],s=THREE.PropertyBinding.parseTrackName(o.name),l=THREE.PropertyBinding.findNode(t,s.nodeName);if("morphTargetInfluences"===s.propertyName&&void 0!==s.propertyIndex){if(o.createInterpolant!==o.InterpolantFactoryMethodDiscrete&&o.createInterpolant!==o.InterpolantFactoryMethodLinear){if(o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(o=o.clone()).setInterpolation(THREE.InterpolateLinear)}var u,c=l.morphTargetInfluences.length,f=l.morphTargetDictionary[s.propertyIndex];if(void 0===f)throw new Error("THREE.GLTFExporter: Morph target name not found: "+s.propertyIndex);if(void 0!==n[l.uuid]){var p=o.createInterpolant(new o.ValueBufferType(1));u=n[l.uuid];for(g=0;g<u.times.length;g++)u.values[g*c+f]=p.evaluate(u.times[g]);for(g=0;g<o.times.length;g++){var m=this.insertKeyframe(u,o.times[g]);u.values[m*c+f]=o.values[g]}}else{for(var h=new((u=o.clone()).ValueBufferType)(c*u.times.length),g=0;g<u.times.length;g++)h[g*c+f]=u.values[g];u.name=".morphTargetInfluences",u.values=h,n[l.uuid]=u,r.push(u)}}else r.push(o)}return e.tracks=r,e}}}]);